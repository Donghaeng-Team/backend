name: Build Changed Services After Merge and Push to ECR

on:
  push:
    branches:
      - eks-staging
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  AWS_ACCOUNT_ID: 857360183365
  TAG: ${{ github.sha }}   # ì»¤ë°‹ í•´ì‹œ ê¸°ë°˜ ë²„ì „
  SHORT_SHA: ${{ github.sha }}
  EXCLUDE_DIRS: "common .github"
  ARGOCD_REPO: "https://github.com/Donghaeng-Team/argoCD-manifest.git"
  ARGOCD_BRANCH: "main"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      #7ìë¦¬ë¡œ ë³€ê²½
      - name: Set short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
      #ì½”ë“œ ì²´í¬ ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (merge base ë¹„êµìš©)

      # Gradle ìºì‹±
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      #JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: 17
          cache: gradle

      # OIDC ì„¤ì •
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::857360183365:role/bytogether-gitaction-role
          aws-region: ${{ env.AWS_REGION }}

      #ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      #ë³€ê²½ ì‚¬í•­ ê°ì§€
      - name: Detect changed services
        id: detect
        run: |
          echo "ğŸ” Detecting changed services in merge commit..."
          git fetch --all

          # ë¨¸ì§€ ì»¤ë°‹ì˜ ë‘ ë²ˆì§¸ ë¶€ëª¨(ë¨¸ì§€ëœ ë¸Œëœì¹˜)ì™€ ë¹„êµ
          BASE=$(git rev-parse HEAD^1)
          ##MERGED=$(git rev-parse HEAD^2)

          git diff --name-only $BASE HEAD > changed_files.txt

          echo "ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
          cat changed_files.txt || true

          CHANGED_DIRS=$(grep '/' changed_files.txt | cut -d'/' -f1 | sort -u | uniq)
          TARGETS=""
          for DIR in $CHANGED_DIRS; do
            if [[ -d $DIR && ! " $EXCLUDE_DIRS " =~ " $DIR " ]]; then
              TARGETS="$TARGETS $DIR"
            fi
          done
          echo "targets=$(echo $TARGETS | xargs)" >> $GITHUB_OUTPUT
          echo "ë¨¸ì§€ë¡œ ë³€ê²½ëœ ì„œë¹„ìŠ¤: $TARGETS"

      # ë¹Œë“œ & í‘¸ì‰¬
      - name: Build and Push changed services
        if: steps.detect.outputs.targets != ''
        run: |
          for SERVICE in ${{ steps.detect.outputs.targets }}; do
            echo "ğŸ—ï¸ Building and pushing $SERVICE ..."

            if [ ! -f "$SERVICE/build.gradle" ]; then
              echo "âš ï¸ Skipping $SERVICE (no build.gradle found)"
              continue
            fi

            cd $SERVICE
            chmod +x ./gradlew
            ./gradlew clean build -x test

            # âš™ï¸ Dockerfile ê²½ë¡œ ì§€ì • ë¡œì§ ì¶”ê°€
            if [ -f "Dockerfile_$SERVICE" ]; then
              DOCKER_FILE="Dockerfile_$SERVICE"
            elif [ -f "Dockerfile" ]; then
              DOCKER_FILE="Dockerfile"
            else
              echo "âŒ No Dockerfile found for $SERVICE, skipping."
              cd ..
              continue
            fi

            echo "ğŸ§± Using Dockerfile: $DOCKER_FILE"

            # ECR repo ìë™ ìƒì„±
             aws ecr describe-repositories --repository-names bytogether-eks/$SERVICE --region $AWS_REGION > /dev/null 2>&1 || \
             aws ecr create-repository --repository-name bytogether-eks/$SERVICE --region $AWS_REGION


            # ìºì‹œ í™œìš©
            docker pull $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:latest || true

            docker build -t $SERVICE:$SHORT_SHA -f $DOCKER_FILE . \
              --cache-from $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:latest

            #ë°°í¬ íƒœê·¸ , ì¶”ì  íƒœê·¸ ì ìš©
            docker tag $SERVICE:$SHORT_SHA $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:$SHORT_SHA
            docker tag $SERVICE:$SHORT_SHA $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:latest

            docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:$SHORT_SHA
            docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/bytogether-eks/$SERVICE:latest
            cd ..
          done
      # ArgoCD Manifest ì—…ë°ì´íŠ¸
      - name: Update ArgoCD Manifest
        if: steps.detect.outputs.targets != ''
        env:
          GITHUB_TOKEN: ${{ secrets.ARGOCD_MANIFEST_TOKEN }}
        run: |
          echo "ğŸ“ Updating ArgoCD manifest repository..."
          
          # Git ì„¤ì •
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ArgoCD manifest ì €ì¥ì†Œ í´ë¡ 
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/Donghaeng-Team/argoCD-manifest.git argocd-manifest
          cd argocd-manifest
          git checkout ${{ env.ARGOCD_BRANCH }}
          
          # ë³€ê²½ëœ ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ manifest ì—…ë°ì´íŠ¸
          UPDATED_SERVICES=""
          for SERVICE in ${{ steps.detect.outputs.targets }}; do
            echo "ğŸ”„ Updating manifest for $SERVICE..."
            
            # íŒŒì¼ëª… íŒ¨í„´: argo-{ì„œë¹„ìŠ¤ëª…}.yaml
            YAML_FILE="stage/argo-${SERVICE}.yaml"
            
            if [ ! -f "$YAML_FILE" ]; then
              echo "âš ï¸ Manifest file not found: $YAML_FILE, skipping..."
              continue
            fi
            
            echo "ğŸ“„ Found manifest: $YAML_FILE"
            
            # backend.image.tagì˜ value ê°’ì„ ìƒˆë¡œìš´ SHORT_SHAë¡œ ì—…ë°ì´íŠ¸
            # íŒ¨í„´: "value: 'e638cf2'" í˜•íƒœë¥¼ ì°¾ì•„ì„œ êµì²´
            sed -i "/name: 'backend\.image\.tag'/{ n; s/value: '[^']*'/value: '${{ env.SHORT_SHA }}'/; }" "$YAML_FILE"
            
            UPDATED_SERVICES="$UPDATED_SERVICES $SERVICE"
          done
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ & í‘¸ì‹œ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸš€ Update image tags for:$UPDATED_SERVICES to ${{ env.SHORT_SHA }}"
            git push origin ${{ env.ARGOCD_BRANCH }}
            echo "âœ… Successfully updated ArgoCD manifests!"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
          
          cd ..
          rm -rf argocd-manifest

      # ì•ˆë°”ë€Œì—ˆìœ¼ë©´ í†µê³¼
      - name: No changed services
        if: steps.detect.outputs.targets == ''
        run: echo "âœ… No changed services in this merge."
